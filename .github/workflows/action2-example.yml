name: üöÄ GitHub Actions Power Demo

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main]
    schedule:
        # Run daily at 2 AM UTC
        - cron: "0 2 * * *"
    workflow_dispatch: # Allow manual trigger

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}

jobs:
    # Job 1: Code Quality & Testing
    quality-checks:
        name: Code Quality & Tests
        runs-on: ubuntu-latest
        permissions:
            contents: read
            checks: write

        strategy:
            matrix:
                node-version: [18.x, 20.x]
                os: [ubuntu-latest, windows-latest]

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Run linter
              run: npm run lint --if-present
              continue-on-error: true

            - name: Run tests
              run: npm test --if-present
              continue-on-error: true

            - name: Build project
              run: npm run build --if-present

    # Job 2: Security Scanning
    security-scan:
        name: üîí Security Analysis
        runs-on: ubuntu-latest
        permissions:
            contents: read
            security-events: write

        steps:
            - uses: actions/checkout@v4

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: "fs"
                  scan-ref: "."
                  format: "sarif"
                  output: "trivy-results.sarif"
              continue-on-error: true

            - name: Upload Trivy results to GitHub Security
              uses: github/codeql-action/upload-sarif@v2
              if: always()
              with:
                  sarif_file: "trivy-results.sarif"

    # Job 3: Documentation Generation
    docs:
        name: üìö Generate Documentation
        runs-on: ubuntu-latest
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'

        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Generate docs
              run: npm run docs --if-present || echo "No docs script defined"

            - name: Deploy documentation
              uses: actions/upload-artifact@v3
              with:
                  name: documentation
                  path: docs/
                  if-no-files-found: ignore

    # Job 4: Container Image Build & Push
    container:
        name: üê≥ Build & Push Container
        runs-on: ubuntu-latest
        if: github.event_name == 'push'
        permissions:
            contents: read
            packages: write

        steps:
            - uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to Container Registry
              if: github.ref == 'refs/heads/main'
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
                  tags: |
                      type=ref,event=branch
                      type=sha
                      type=semver,pattern={{version}}

            - name: Build and push image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  push: ${{ github.ref == 'refs/heads/main' }}
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

    # Job 5: Notifications & Reporting
    notify:
        name: üì¢ Notifications
        runs-on: ubuntu-latest
        if: always()
        needs: [quality-checks, security-scan, docs, container]

        steps:
            - name: Check job results
              run: |
                  echo "Quality Checks: ${{ needs.quality-checks.result }}"
                  echo "Security Scan: ${{ needs.security-scan.result }}"
                  echo "Documentation: ${{ needs.docs.result }}"
                  echo "Container Build: ${{ needs.container.result }}"

            - name: Create workflow summary
              run: |
                  echo "## Workflow Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
                  echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
                  echo "| Quality Checks | ${{ needs.quality-checks.result }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Documentation | ${{ needs.docs.result }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Container Build | ${{ needs.container.result }} |" >> $GITHUB_STEP_SUMMARY

            - name: Send Slack notification
              if: failure()
              uses: slackapi/slack-github-action@v1
              with:
                  webhook-url: ${{ secrets.SLACK_WEBHOOK }}
                  payload: |
                      {
                        "text": "‚ùå GitHub Actions workflow failed",
                        "blocks": [
                          {
                            "type": "section",
                            "text": {
                              "type": "mrkdwn",
                              "text": "*Workflow Failed* üö®\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref }}\n*Actor:* ${{ github.actor }}"
                            }
                          }
                        ]
                      }
              continue-on-error: true
