name: Release pipeline
run-name: "B3 release.${{ inputs.build_date }}.${{ inputs.build_run_number }}"

on:
    workflow_dispatch:
        inputs:
            build_date:
                description: "Build date (yyyy-mm-dd)"
                required: true
                type: string
            build_run_number:
                description: "Build run number"
                required: true
                type: string
            build_ref:
                description: "Branch or tag to release from"
                required: false
                default: "main"
                type: string

jobs:
    release:
        runs-on: ubuntu-latest
        permissions:
            contents: read

        steps:
            - uses: actions/checkout@v4
              with:
                  ref: ${{ inputs.build_ref }}

            - name: Prepare release package
              run: |
                  test -f index.html
                  mkdir -p release
                                    VERSIONED_HTML="index-${{ inputs.build_date }}-${{ inputs.build_run_number }}.html"
                                    cp index.html "release/$VERSIONED_HTML"
                                    tar -czf release/web-release.tar.gz -C release "$VERSIONED_HTML"

            - name: Release metadata
              run: |
                  echo "RELEASE | build=${{ inputs.build_date }}.${{ inputs.build_run_number }} | ref=${{ inputs.build_ref }} | actor=${{ github.actor }} | repo=${{ github.repository }} | workflow_run=${{ github.run_number }} | file=index-${{ inputs.build_date }}-${{ inputs.build_run_number }}.html | package=release/web-release.tar.gz"

            - name: Upload release package artifact
              uses: actions/upload-artifact@v4
              with:
                  name: web-release-${{ inputs.build_date }}-${{ inputs.build_run_number }}
                  path: release/web-release.tar.gz
